# 第11章 如何设计API

在设计 API 时，选择使用输出参数（out parameters）还是返回参数（return parameters），或者使用智能指针如 `std::unique_ptr`，取决于具体的使用场景和设计目标。以下是一些考虑因素:

## 1. 使用返回参数（例如 `std::unique_ptr`）

**优点：**

1. **自然语义**：返回值通常更符合自然语义，特别是在函数执行成功时返回一个对象。
2. **异常安全**：使用 `std::unique_ptr` 可以确保在函数抛出异常时不会发生资源泄漏。
3. **简化调用代码**：调用者可以直接处理返回值，而不需要预先声明变量。

**缺点：**

1. **复杂类型**：如果返回的类型非常复杂，可能会影响性能，因为需要构造和析构对象。
2. **多值返回**：如果需要返回多个值，使用返回值可能会变得复杂。

**示例：**

```c++
std::unique_ptr<MyClass> createMyClass() {
    return std::make_unique<MyClass>();
}
```

## 2. 使用输出参数

**优点：**

1. **多值返回**：可以方便地返回多个值，而不需要使用复杂的结构或元组。
2. **性能优化**：对于大型对象，通过引用传递可以避免不必要的拷贝构造和析构。

**缺点：**

1. **异常安全**：需要额外注意确保在函数抛出异常时不会发生资源泄漏。
2. **调用复杂性**：调用者需要预先声明变量，并且需要处理可能的错误情况。

**示例：**

```c++
void createMyClass(MyClass*& outParam) {
    outParam = new MyClass();
}
```

## 3. 综合考虑

在实际设计中，可以根据以下原则进行选择：

1. **自然语义**：如果函数的主要目的是创建并返回一个对象，使用返回值更自然。
2. **异常安全**：如果需要确保资源管理的安全性，使用 `std::unique_ptr` 或其他智能指针。
3. **性能考虑**：如果返回的对象非常大，或者需要返回多个值，使用输出参数可能更合适。
4. **代码简洁性**：返回值通常使调用代码更简洁和易读。

```c++
std::unique_ptr<MyClass> createMyClass() {
    return std::make_unique<MyClass>();
}

void createMyClass(MyClass*& outParam) {
    outParam = new MyClass();
}
```

在现代 C++ 中，推荐使用返回值和智能指针（如 `std::unique_ptr`）来确保代码的简洁性和异常安全性。只有在特定情况下，例如需要返回多个值或对性能有严格要求时，才考虑使用输出参数。

在选择智能指针时，主要考虑的是所有权的管理。`std::unique_ptr` 和 `std::shared_ptr` 是两种最常用的智能指针，它们分别适用于不同的场景。

### `std::unique_ptr`

**适用场景：**

- 当你需要表达独占所有权时，即一个对象只有一个所有者。
- 当你希望确保资源在不再需要时能够立即且唯一地被释放。
- 当你不需要共享所有权时。

**优点：**

- 高效：`std::unique_ptr` 是轻量级的，没有额外的引用计数开销。
- 明确：独占所有权使得代码的意图更加明确。

**示例：**

```c++
std::unique_ptr<MyClass> createMyClass() {
    return std::make_unique<MyClass>();
}
```

### `std::shared_ptr`

**适用场景：**

- 当你需要共享所有权时，即多个对象可以共享同一个资源。
- 当你希望资源在最后一个所有者释放时才被销毁。

**优点：**

- 灵活：允许多个对象共享同一个资源。
- 自动管理：引用计数确保资源在不再需要时被正确释放。

**缺点：**

- 开销：`std::shared_ptr` 有额外的引用计数开销，可能会影响性能。
- 复杂性：共享所有权可能会增加代码的复杂性，特别是在循环引用的情况下。

**示例：**

```c++
std::shared_ptr<MyClass> createMyClass() {
    return std::make_shared<MyClass>();
}
```

**选择建议**

在大多数情况下，特别是当你只需要独占所有权时，`std::unique_ptr` 是更合适的选择。它提供了足够的功能，同时保持了高效和简单。

**总结：**

- **使用 `std::unique_ptr`**：当你需要独占所有权，且不需要共享资源时。
- **使用 `std::shared_ptr`**：当你需要共享所有权，且资源可以被多个对象共享时。

在设计 API 时，如果返回的对象不需要共享所有权，推荐使用 `std::unique_ptr`。这不仅符合现代 C++ 的最佳实践，还能确保代码的高效和清晰。